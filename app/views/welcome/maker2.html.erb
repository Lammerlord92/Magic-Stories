<!-- Page passes the container for the graph to the program -->
<div>
  <!--
  <table style="position:relative;">
    <tr>
      <td>
        <div id="graphContainer"
             style="position:relative;overflow:auto;top:30px;left:0px;bottom:0px;right:0px;width:100%;height:100%;
             border:solid 1px black;cursor:default;">
        </div>
      </td>
      <td valign="top">
        <div id="properties"
             style="border: solid 1px black; padding: 10px;">
        </div>
      </td>
    </tr>
  </table>
  -->
  <style>
    #graphContainer{
      position:relative;
      overflow:auto;
      left:0px;
      bottom:0px;
      right:0px;
      width:100%;
      height:100%;
      border:solid 2px darkgrey;
      cursor:default;
    }
    #properties{
      border:  solid 2px darkgrey;
      padding: 10px;
    }
  </style>
  <table width="100%" height="100%" border="0" cellspacing="0" cellpadding="0">
    <tr>
      <td id="toolbox" valign="top" width="70px" style="min-width:70px;background:#7F7F7F;padding:12px;">
        <img src="http://etc.usf.edu/clipart/40600/40690/pb_sq_40690_lg.gif" width="70px" height="70px"><br/>
        <img src="http://2.bp.blogspot.com/-MZAjo7HkgNE/TqUZQPShXQI/AAAAAAAAB9c/c5Xy3HBhk_g/s1600/GlobeCircle+copy.png" width="70px" height="70px"><br/>
      </td>
      <td>
        <div id="graphContainer"></div>
        <br>
        <div id="properties">
          <!--TODO ESTO ES EL EDITOR QUE QUEREMOS QUE SE MUESTRE-->
          <input type="button" value="B" onclick="mod_selection('[b]','[/b]')" />
          <input type="button" value="/" onclick="mod_selection('[i]','[/i]')" />
          <input type="button" value="_" onclick="mod_selection('[u]','[/u]')" />
          <br />

          <!-- Text area -->
          <textarea class="text_edit" id="my_text"></textarea>
          <br />

          <!-- Submit button -->
          <input type="button" value="Show text" onclick="view_text()" />

          <!-- Empty div to put the text in -->
          <div id="view_text">
          </div>
          <!--TODO HASTA AQUI-->

        </div>
      </td>
    </tr>
  </table>

  <!-- fuken: WTF es esto ?? Un form que postea cosas a un servidor php ??
  <section id="modal" class="modal fade">
    <div class="modal-body">
      <form action="buttonStory.php" method="post" role="form">
        <span id="close" onclick="close();" class="glyphicon glyphicon-remove circle pull-right"></span>

        <div class="form-group">
          <label for="description">Description</label>

          createTextArea(graph, form, cell, attrs[i]);

          <textarea typeof="text" class="form-control" id="description" placeholder="Enter Description"></textarea>
        </div>

      </form>
    </div>
  </section>
  -->

  <!-- Sets the basepath for the library if not in same directory -->
  <script type="text/javascript">
    mxBasePath = '../src';
  </script>

  <script type="text/javascript" src="../../assets/javascripts/widgEditor.js"></script>

  <!-- Loads and initializes the library -->
  <script type="text/javascript" src="/assets/javascripts/mxClient.js"></script>

  <!-- Example code -->
  <script type="text/javascript">

    // fuken: Esta funcion de jQuery carga la funcion main
    //        cuando el html ha sido cargado entero
    $(document).ready(function main() {
      var container = document.getElementById('graphContainer');
      // Checks if the browser is supported
      if (!mxClient.isBrowserSupported()) {
        // Displays an error message if the browser is not supported.
        mxUtils.error('Browser is not supported!', 200, false);
      }
      else {
        // Note that these XML nodes will be enclosing the
        // mxCell nodes for the model cells in the output
        var xml = mxUtils.createXmlDocument();

        var chapter1 = xml.createElement('Chapter');
        chapter1.setAttribute('title', 'Juanoide presenta');
        chapter1.setAttribute('body', 'Juan ha ido a ISPP');

        var chapter2 = xml.createElement('Chapter');
        chapter2.setAttribute('title', 'Juanoide pone la numeración');
        chapter2.setAttribute('body', 'Juanoide ha hecho las cosas bien');

        var chapter3 = xml.createElement('Chapter');
        chapter3.setAttribute('title', 'El grupo 1 se queja');
        chapter3.setAttribute('body', 'Buuuuu');

        var chapter4 = xml.createElement('Chapter');
        chapter4.setAttribute('title', 'Juanoide no pone la numeración');
        chapter4.setAttribute('body', 'Juanoide no ha hecho las cosas bien');

        var relation = xml.createElement('sendTo');
        relation.setAttribute('since', '1985');

        // Creates the graph inside the given container
        var graph = new mxGraph(container);

        // fuken: sacar el objeto graph como propiedad global
        //        para poder verlo en la consola del navegador
        window.gr = graph;

        // Optional disabling of sizing
        graph.setCellsResizable(false);

        //Javi: No permite mover flechas
        graph.setAllowDanglingEdges(false);
        // Configures the graph contains to resize and
        // add a border at the bottom, right
        graph.setResizeContainer(true);
        graph.minimumContainerSize = new mxRectangle(0, 0, 500, 380);
        graph.setBorder(60);

        // Stops editing on enter key, handles escape
        new mxKeyHandler(graph);

        // Overrides method to disallow edge label editing
        graph.isCellEditable = function (cell) {
          return !this.getModel().isEdge(cell);
        };

        // Overrides method to provide a cell label in the display
        graph.convertValueToString = function (cell) {
          if (mxUtils.isNode(cell.value)) {
            if (cell.value.nodeName.toLowerCase() == 'chapter') {
              var title = cell.getAttribute('title', '');
              var body  = cell.getAttribute('body', '');

              if (body != null && body.length > 0) {
                //return body + ', ' + title;
                return title;
              }

              return title;
            }
            else if (cell.value.nodeName.toLowerCase() == 'sendTo') {
              return cell.value.nodeName + ' (Since '
                  + cell.getAttribute('since', '') + ')';
            }

          }

          return '';
        };

        // Overrides method to store a cell label in the model
        var cellLabelChanged = graph.cellLabelChanged;
        graph.cellLabelChanged = function (cell, newValue, autoSize) {
          if (mxUtils.isNode(cell.value) &&
              cell.value.nodeName.toLowerCase() == 'chapter') {
            var pos = newValue.indexOf(' ');

            var title = (pos > 0) ? newValue.substring(0,pos)                    : newValue;
            var body  = (pos > 0) ? newValue.substring(pos + 1, newValue.length) : '';

            // Clones the value for correct undo/redo
            var elt = cell.value.cloneNode(true);

            elt.setAttribute('title', title);
            elt.setAttribute('body', body);

            newValue = elt;
            autoSize = true;
          }

          cellLabelChanged.apply(this, arguments);
        };

        // Overrides method to create the editing value
        var getEditingValue = graph.getEditingValue;
        graph.getEditingValue = function (cell) {
          if (mxUtils.isNode(cell.value) &&
              cell.value.nodeName.toLowerCase() == 'chapter') {
            var title = cell.getAttribute('title', '');
            var body = cell.getAttribute('body', '');

            return title + ' ' + body;
          }
        };

        // Adds a special tooltip for edges
        graph.setTooltips(true);

        var getTooltipForCell = graph.getTooltipForCell;
        graph.getTooltipForCell = function (cell) {
          // Adds some relation details for edges
          if (graph.getModel().isEdge(cell)) {
            var src = this.getLabel(this.getModel().getTerminal(cell, true));
            var trg = this.getLabel(this.getModel().getTerminal(cell, false));

            return src + ' ' + cell.value.nodeName + ' ' + trg;
          }

          return getTooltipForCell.apply(this, arguments);
        };

        // Enables rubberband selection
        new mxRubberband(graph);

        // Adds an option to view the XML of the graph
        document.querySelector('#bodyCol').appendChild(mxUtils.button('View XML', function () {
          var encoder = new mxCodec();
          var node = encoder.encode(graph.getModel());
          mxUtils.popup(mxUtils.getPrettyXml(node), true);
        }));

        // Changes the style for match the markup
        // Creates the default style for vertices
        var style = graph.getStylesheet().getDefaultVertexStyle();
        style[mxConstants.STYLE_STROKECOLOR] = 'gray';
        style[mxConstants.STYLE_ROUNDED] = true;
        style[mxConstants.STYLE_SHADOW] = true;
        style[mxConstants.STYLE_FILLCOLOR] = '#DFDFDF';
        style[mxConstants.STYLE_GRADIENTCOLOR] = 'white';
        style[mxConstants.STYLE_FONTCOLOR] = 'black';
        style[mxConstants.STYLE_FONTSIZE] = '12';
        style[mxConstants.STYLE_SPACING] = 4;

        // Creates the default style for edges
        style = graph.getStylesheet().getDefaultEdgeStyle();
        style[mxConstants.STYLE_STROKECOLOR] = '#0C0C0C';
        style[mxConstants.STYLE_LABEL_BACKGROUNDCOLOR] = 'white';
        style[mxConstants.STYLE_EDGE] = mxEdgeStyle.ElbowConnector;
        style[mxConstants.STYLE_ROUNDED] = true;
        style[mxConstants.STYLE_FONTCOLOR] = 'black';
        style[mxConstants.STYLE_FONTSIZE] = '10';

        // Gets the default parent for inserting new cells. This
        // is normally the first child of the root (ie. layer 0).
        var parent = graph.getDefaultParent();

        // Adds cells to the model in a single step
        graph.getModel().beginUpdate();
        try {
          //var w = chapter1.getAttribute('title').length * 7;

          var v1 = graph.insertVertex(parent, null, chapter1, 40, 40, chapter1.getAttribute('title').length * 7, 30);
          var v2 = graph.insertVertex(parent, null, chapter2, 200, 150, chapter2.getAttribute('title').length * 7, 30);
          var v3 = graph.insertVertex(parent, null, chapter3, 450, 125, chapter3.getAttribute('title').length * 7, 30);
          var v4 = graph.insertVertex(parent, null, chapter4, 200, 100, chapter4.getAttribute('title').length * 7, 30);

          var e1 = graph.insertEdge(parent, null, relation, v1, v2);
          var e2 = graph.insertEdge(parent, null, relation, v2, v3);
          var e3 = graph.insertEdge(parent, null, relation, v1, v4);
          var e4 = graph.insertEdge(parent, null, relation, v4, v3);
        }
        finally {
          // Updates the display
          graph.getModel().endUpdate();
        }

        // Implements a properties panel that uses
        // mxCellAttributeChange to change properties
        //TODO ESTO ESTA COMENTADO PARA QUE NOS SALGA EL EDITOR Y EVITAR QUE AL SELECCIONAR EL GRAFO NO SE NOS MUESTRE, COMPROBAR MAÑANA COMO SE HARÍA MEJOR
        /*graph.getSelectionModel().addListener(mxEvent.CHANGE, function (sender, evt) {
          selectionChanged(graph);
        });

        selectionChanged(graph);*/
      }

      /**
       * Updates the properties panel
       */
      function selectionChanged(graph) {
        var div = document.getElementById('properties');

        // Forces focusout in IE
        graph.container.focus();

        // Clears the DIV the non-DOM way
        div.innerHTML = '';

        // Gets the selection cell
        var cell = graph.getSelectionCell();

        if (cell == null) {
          //mxUtils.writeln(div, 'Nothing selected.');
        }
        else {

          // Writes the title
          var center = document.createElement('center');
          mxUtils.writeln(center, cell.value.nodeName + ' (' + cell.id + ')');
          div.appendChild(center);
          mxUtils.br(div);

          // Creates the form from the attributes of the user object
          var form = new mxForm();

          //MAKER 5

          //TODO METO AQUI EL MAKER 5 PERO NO ME ESTA PILLANDO EL textArea

          /*var textArea = document.getElementById('my_text');
          var div = document.getElementById('view_text');

          // Put the text in a variable so we can manipulate it.
          var text = textArea.value;

          // Make sure html and php tags are unusable by disabling < and >.
          text = text.replace(/\</gi, "<");
          text = text.replace(/\>/gi, ">");

          // Exchange newlines for <br />
          text = text.replace(/\n/gi, "<br />");

          // Basic BBCodes.
          text = text.replace(/\[b\]/gi, "<b>");
          text = text.replace(/\[\/b\]/gi, "</b>");

          text = text.replace(/\[i\]/gi, "<i>");
          text = text.replace(/\[\/i\]/gi, "</i>");

          text = text.replace(/\[u\]/gi, "<u>");
          text = text.replace(/\[\/u\]/gi, "</u>");

          // Print the text in the div made for it.
          div.innerHTML = text;
        }

        function mod_selection (val1,val2) {
          // Get the text area
          var textArea = document.getElementById('my_text');

          // IE specific code.
          if( -1 != navigator.userAgent.indexOf ("MSIE") ) {

            var range = document.selection.createRange();
            var stored_range = range.duplicate();

            if(stored_range.length > 0) {
              stored_range.moveToElementText(textArea);
              stored_range.setEndPoint('EndToEnd', range);
              textArea.selectionStart = stored_range.text.length - range.text.length;
              textArea.selectionEnd = textArea.selectionStart + range.text.length;
            }
          }
          // Do we even have a selection?
          if (typeof(textArea.selectionStart) != "undefined") {
            // Split the text in three pieces - the selection, and what comes before and after.
            var begin = textArea.value.substr(0, textArea.selectionStart);
            var selection = textArea.value.substr(textArea.selectionStart, textArea.selectionEnd - textArea.selectionStart);
            var end = textArea.value.substr(textArea.selectionEnd);

            // Insert the tags between the three pieces of text.
            textArea.value = begin + val1 + selection + val2 + end;
          }
        }*/

          //END MAKER 5

          //TODO ESTA PARTE DE ABAJO ES LO QUE SE MUESTRA AL SELECCIONAR UNA CELDA DEL GRAFO

          /*var attrs = cell.value.attributes;

          for (var i = 0; i < attrs.length; i++) {
            if (i == 0) {
              createTextField(graph, form, cell, attrs[i]);
            } else {
              createTextArea(graph, form, cell, attrs[i]);
            }
          }*/

          //div.appendChild(form.getTable());
          mxUtils.br(div);
        }
      };

      /**
       * Creates the textfield for the given property.
       */
      function createTextField(graph, form, cell, attribute) {
        var input = form.addText(attribute.nodeName + ':', attribute.nodeValue);

        var applyHandler = function () {
          var newValue = input.value || '';
          var oldValue = cell.getAttribute(attribute.nodeName, '');

          if (newValue != oldValue) {
            graph.getModel().beginUpdate();

            try {
              var edit = new mxCellAttributeChange(
                  cell, attribute.nodeName,
                  newValue);
              graph.getModel().execute(edit);
              graph.updateCellSize(cell);
            }
            finally {
              graph.getModel().endUpdate();
            }
          }
        };

        mxEvent.addListener(input, 'keypress', function (evt) {
          // Needs to take shift into account for textareas
          if (evt.keyCode == /*enter*/13 && !mxEvent.isShiftDown(evt)) {
            input.blur();
          }
        });

        if (mxClient.IS_IE) {
          mxEvent.addListener(input, 'focusout', applyHandler);
        }
        else {
          // Note: Known problem is the blurring of fields in
          // Firefox by changing the selection, in which case
          // no event is fired in FF and the change is lost.
          // As a workaround you should use a local variable
          // that stores the focused field and invoke blur
          // explicitely where we do the graph.focus above.
          mxEvent.addListener(input, 'blur', applyHandler);
        }
      }

    // ¿para que sirve esta funcion?
    // Esta dentro del modal que nunca se muestra
    function createTextArea(graph, form, cell, attribute)
    {
      var input = form.addTextarea(attribute.nodeName + ':', attribute.nodeValue);

      var applyHandler = function()
      {
        var newValue = input.value || '';
        var oldValue = cell.getAttribute(attribute.nodeName, '');

        if (newValue != oldValue)
        {
          graph.getModel().beginUpdate();

          try
          {
            var edit = new mxCellAttributeChange(
                cell, attribute.nodeName,
                newValue);
            graph.getModel().execute(edit);
            graph.updateCellSize(cell);
          }
          finally
          {
            graph.getModel().endUpdate();
          }
        }
      };

      mxEvent.addListener(input, 'keypress', function (evt)
      {
        // Needs to take shift into account for textareas
        if (evt.keyCode == /*enter*/13 &&
            !mxEvent.isShiftDown(evt))
        {
          input.blur();
        }
      });

      if (mxClient.IS_IE)
      {
        mxEvent.addListener(input, 'focusout', applyHandler);
      }
      else
      {
        // Note: Known problem is the blurring of fields in
        // Firefox by changing the selection, in which case
        // no event is fired in FF and the change is lost.
        // As a workaround you should use a local variable
        // that stores the focused field and invoke blur
        // explicitely where we do the graph.focus above.
        mxEvent.addListener(input, 'blur', applyHandler);
      }
    };})
  </script>

  <script type="text/javascript">
    $(document).ready(function() {
      $("#buttonStory").on('click',function(){
        $("#modal").modal({
          show:true
        });
        $("#close").on('click',function(){
          $("#modal").modal('hide');
        });
      })
    })
  </script>

</div>