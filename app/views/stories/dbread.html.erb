<div class="container">

  <!-- Título y autor -->
  <div class="text-center book-title">
    <h1><%= @story.title %></h1>
    <h3><%= @story.creatorProfile.name %></h3>
  </div>

  <div ng-app="reader" ng-controller="ReaderController">
  
    <!-- Enlaces -->
    <div ng-show="parent_id || next || prev" class="row book-top">
      <div class="col-md-4 col-md-offset-2">
        <a ng-show="parent_id" ng-click="setChapter(parent_id)" class="book-back">
          <span class="glyphicon glyphicon-chevron-left"></span>&nbsp;Atrás
        </a>
        <a ng-show="prev" class="book-page">
          <span class="glyphicon glyphicon-chevron-left"></span>&nbsp;Página anterior
        </a>
      </div>
      <div class="col-md-4" align="right">
        <a ng-show="next" class="book-page">
          <span>Página siguiente&nbsp;<span class="glyphicon glyphicon-chevron-right"></span></span>
        </a>
      </div>
    </div>

    <!-- Libro -->
    <div class="row book">
      
      <!-- Página izquierda -->
      <div class="col-md-4 col-md-offset-2">
        
        <!--Animación de loading-->
        <h2 class="text-center" ng-show="loading">
          <img src="/ripple.svg" alt="Loading...">
        </h2>

        <!-- Contenido de la página -->
        <article ng-hide="loading">

          <!-- División izquierda -->
          <div>

            <!-- TODO ahora muestra todo-->

            <!-- Cuerpo del capítulo -->
            <p ng-bind-html="current_chapter? current_chapter.body : 'No hay cuerpo del capitulo/nodo'"></p>
            <p ng-hide="options.length > 0" class="text-center"><b>FIN</b></p>

            <!-- Lista de opciones -->
            <ul id="options-list" class="list-unstyled">
              <li ng-repeat="option in options">
                <a ng-click="setChapter(option.child_id)" class="book-option">
                  <p><span class="glyphicon glyphicon-chevron-right"></span>&nbsp;{{option.option}}</p>
                </a>
              </li>
            </ul>

          </div>

        </article>

      </div>

      <!-- Página derecha -->
      <div class="col-md-4">
        
        <!--Animación de loading-->
        <h2 class="text-center" ng-show="loading">
          <img src="/ripple.svg" alt="Loading...">
        </h2>

        <!-- Contenido de la página -->
        <article ng-hide="loading">

          <!-- División derecha -->
          <div>
            <!-- TODO -->
          </div>

        </article>

      </div>

    </div>

  </div>

</div>

<script type="text/javascript" charset="utf-8">
  
  (function(){
    angular.module("reader", ["ngSanitize"]).controller("ReaderController", function($scope, $sanitize){
      
      $scope.loading = true;
      
      /* Page buttons */
      $scope.prev = false;
      $scope.next = false;

      $scope.parent_id = null;
      $scope.options = [];
      $scope.current_chapter = null;
      
      $scope.setChapter = function setChapter(id){
        $scope.loading = true;
        $.get("/chapters/"+id+".json", function(chapter){
          var first_parent = chapter.parent_options[0];
          chapter.body = $sanitize(chapter.body);
          console.log((chapter.body));
          $scope.options = chapter.child_options;
          $scope.parent_id = first_parent? first_parent.parent_id: null;
          $scope.current_chapter = chapter;
          $scope.loading = false;
          $scope.$digest();
        })
      };

      $scope.setChapter(<%= @story.chapters.first.id %>);

      function split(element){
        var splitted = [];
        var total = element.clone();
        while (total.height() > 430){
          var part = null;
          /* TODO total.first_element --move-> part */
          while (part.height() < 430){
            /* TODO total.next_element --move-> part */
          }
          splitted.push(part);
        }
        splitted.push(total);
        return splitted;
      }

    });
  })();

</script>